<!DOCTYPE html>
<html>
<head>
</head>
<body>

<style>

div {
	border-style:solid;
	border-width:1px;
	width: 90%;
	height: 5em;

	white-space: pre-wrap;      /* CSS3 */   
	white-space: -moz-pre-wrap; /* Firefox */    
	white-space: -pre-wrap;     /* Opera <7 */   
	white-space: -o-pre-wrap;   /* Opera 7 */    
	word-wrap: break-word;      /* IE */
	overflow-y: scroll
}
</style>

<h1>Make password, yes?</h1>
Choose your key file: <input type="file" id="keyfile" /><br>
<i>warning: you will lose your passwords losing this file, or modifying it in any way!</i><br><br>
Enter the URL of your site: <input type="text" id="input"> <span id="actualurl"></span> <br><br>
Set the password length: <input type="text" id="length" value="20"/><br><br>
<br>
<span id="output"></span>
<h2><span id="result"></span></h2>
<br>
<input id="digest" type="button" onclick="digest()" value="Make!" disabled="true">
<br>
<br>
<i>hint: use CTRL+C to copy your new password!</i>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha256.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/hmac.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha3.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64-min.js"></script>
<script>

if (window.File && window.FileReader && window.FileList && window.Blob) {
  // Great success! All the File APIs are supported.
} else {
  alert('The File APIs are not fully supported in this browser.');
}

var key = null;
var actualURL = null;
var currentURL = '';

//allow for insta-copy-paste

autoSelect( document.getElementById("input") )

function autoSelect (elem) {

  	var tag = (elem.tagName || "").toLowerCase(), 
      sel, range;
  
  if (tag === "textarea" || tag === "input") {
    try {
      elem.select();
    } catch(e) {
      // May be disabled or not selectable
    }
  } else if (window.getSelection) { // Not IE
    sel = window.getSelection();
    range = document.createRange();
    range.selectNodeContents(elem);
    sel.removeAllRanges();
    sel.addRange(range);
  } else if (document.selection) { // IE
    document.selection.empty();
    range = document.body.createTextRange();
    range.moveToElementText(elem);
    range.select();
  }
}

function updateButton() {
	//document.getElementById("digest").disabled = !key || currentURL.length == 0;
	document.getElementById("digest").disabled = !key || !actualURL || actualURL.length == 0;
}

function handleFileSelect(evt) {
	var files = evt.target.files; // FileList object
	
	var reader = new FileReader();

  	// Closure to capture the file information.
  	reader.onload = (function(theFile) {
	    return function(e) {
	    	//make a hard key encrypting the user random file
	    	key = CryptoJS.SHA3(e.target.result);

	    	updateButton();
	    };

  	})(files[0]);

  	// Read in the image file as a data URL.
  	reader.readAsBinaryString(files[0]);
}

function extractDomain( URL ) {
	if( URL.length ) {

		//try to find a domain in there
		//it's actually an harder problem than it looks, could need a server-side thing
		//doesn't work if TLD has a dot inside, but there is no way of knowing without
		//listing special TLDs

		//look for :// and remove up to it
		var startOfAddress = URL.indexOf("://") 
		if(startOfAddress == -1)
			startOfAddress = 0
		else 
			startOfAddress = startOfAddress+3

		//find either the end of file or the first /
		var endOfAddress = URL.indexOf("/", startOfAddress)

		if( endOfAddress == -1 )
			endOfAddress = URL.length

		//there must be at least one point
		var TLDpoint = URL.lastIndexOf('.', endOfAddress)
		if( TLDpoint == -1 )
			return null;

		//and the domain must exist (actually just check length)
		if( TLDpoint >= endOfAddress-2 )
			return null

		//good. now find the previous dot or start
		var domainStart = URL.lastIndexOf('.', TLDpoint-1)
		if( domainStart == -1 )
			domainStart = startOfAddress
		else
			++domainStart

		var address = URL.substring(domainStart, endOfAddress)

		$("#actualurl").html( "(" + address + ")" )
		return address
	}
	else return null;
}

function parseURL() {
	
	actualURL = extractDomain(currentURL)

	updateButton();
}

function digest() {
	if( document.getElementById("digest").disabled )
		return

	var hmacHasher = CryptoJS.algo.HMAC.create(CryptoJS.algo.SHA256, key);

	var pass = hmacHasher.finalize( currentURL ).toString(CryptoJS.enc.Base64);

	$("#output").html( "Your password for <b>" + actualURL + "</b> is<br>"  );

	var l = $("#length").val()

	if( l < 5 )
		l = 5;
	if( l > pass.length-1 )
		l = pass.length-1

	var resultElem = document.getElementById("result");
	resultElem.innerHTML = pass.substring( 0, l )

	autoSelect(resultElem)
}

document.getElementById('keyfile').addEventListener('change', handleFileSelect, false);

$(document).keypress(function(e) {
  if(e.which == 13) {
    $("#digest").click();
  }
});
$("#input").on('change keyup paste mouseup', function() {
    if(event.keyCode == 13) {
        $("#digest").click();
    }
    else if ($(this).val() != currentURL) {
        currentURL = $(this).val();
     	
     	parseURL();
    }
});

</script>

</body>
</html>
